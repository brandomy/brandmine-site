#!/bin/bash
# ============================================================================
# Consolidated Image Processor for Brandmine
# ----------------------------------------------------------------------------
# - Scans all target folders for JPGs under any /originals/ directory
# - Validates ImageMagick availability
# - Detects image orientation (landscape vs portrait)
# - Generates 400w, 800w, 1200w responsive JPGs in the same folder
# - Skips processing if output files already exist
# ============================================================================

# Author: Randal Eastman

# Check if ImageMagick's `convert` is available
command -v convert >/dev/null 2>&1 || {
  echo >&2 "ImageMagick is required but not installed. Aborting."
  exit 1
}

# Define top-level folders to scan
TARGET_DIRS=("brands" "insights" "attributes" "markets" "markets-sectors" "sectors" "signals" "pages" "site")

# If specific folders are passed as arguments, override TARGET_DIRS
if [ "$#" -gt 0 ]; then
  TARGET_DIRS=("$@")
fi

# Define widths for responsive images
WIDTHS=(400 800 1200)

echo "üöÄ Starting consolidated image processing..."

for SECTION in "${TARGET_DIRS[@]}"; do
  DIR="assets/images/$SECTION"

  if [ ! -d "$DIR" ]; then
    echo "‚ö†Ô∏è  Directory not found: $DIR"
    continue
  fi

  echo "üîç Scanning $DIR for JPGs under /originals/..."

  find "$DIR" -type f -path "*/originals/*.jpg" | while read -r ORIGINAL; do
    # Get dimensions
    DIMENSIONS=$(identify -format "%w %h" "$ORIGINAL")
    WIDTH=$(echo "$DIMENSIONS" | awk '{print $1}')
    HEIGHT=$(echo "$DIMENSIONS" | awk '{print $2}')

    # Determine orientation
    if (( HEIGHT > WIDTH )); then
      ORIENTATION="portrait"
    else
      ORIENTATION="landscape"
    fi

    echo "üñºÔ∏è  $ORIGINAL ‚Äî $ORIENTATION (${WIDTH}√ó${HEIGHT})"

    # Parse filename and directory
    ORIGINALS_DIR=$(dirname "$ORIGINAL")
    PARENT_DIR=$(dirname "$ORIGINALS_DIR")
    BASENAME=$(basename "$ORIGINAL" .jpg)

    # Create each responsive version
    for SIZE in "${WIDTHS[@]}"; do
      OUTPUT="$PARENT_DIR/${BASENAME}-${SIZE}w.jpg"

      if [ -f "$OUTPUT" ]; then
        echo "    ‚è≠Ô∏è  Skipping existing $OUTPUT"
        continue
      fi

      echo "    üìê Creating $SIZE-width version: $OUTPUT"

      # Resize based on orientation
      if [ "$ORIENTATION" = "portrait" ]; then
        convert "$ORIGINAL" -resize "x${SIZE}" "$OUTPUT"
      else
        convert "$ORIGINAL" -resize "${SIZE}x" "$OUTPUT"
      fi
    done

    echo "‚úÖ Finished processing $BASENAME.jpg"
    echo ""
  done
done

echo "üéâ All images processed successfully."