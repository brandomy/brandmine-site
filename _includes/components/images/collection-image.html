{% comment %}
  IMAGE COMPONENT: Collection Image
  PURPOSE: Universal responsive image component for all collections with mobile-first optimization and intelligent sizing
  LOCATION: Used throughout Brandmine for brands, founders, insights, dimensions, and site images
  
  PARAMETERS:
  - collection (required): String - Collection name ("brands", "founders", "insights", "dimensions", "site")
  - slug (required): String - Unique identifier (e.g., "ru-teatime", "br-eduardo-santos", "2025-01-market-update")
  - purpose (required): String - Image purpose determining sizing behavior:
    - "hero": Full-width hero images (100vw on mobile)
    - "logo": Brand/company logos (fixed sizes)
    - "portrait": Founder portraits (2:3 aspect)
    - "headshot": Square profile images (1:1 aspect)
    - "gallery": Grid gallery images
    - "thumbnail": Small preview images
    - "feature": Featured content images
  - alt (required): String - Descriptive alt text for accessibility (e.g., "TeaTime storefront in Moscow")
  - category (optional): String - Subcategory for organization ("team", "testimonials", "gallery")
  - name (optional): String - Specific image name override (e.g., "storefront", "portrait", "ceremony")
  - aspect (optional): String - Aspect ratio type. Default: "landscape"
    - "landscape": 3:2 ratio for content images
    - "portrait": 2:3 ratio for people/products
    - "square": 1:1 ratio for logos/icons
  - ratio (optional): String - Custom aspect ratio for data-aspect-ratio attribute
  - class (optional): String - Additional CSS classes for styling
  - ext (optional): String - File extension. Default: "jpg" (also supports "png", "webp")
  - loading (optional): String - Loading priority. Default: "lazy"
    - "lazy": Defer loading until near viewport
    - "eager": Load immediately (use for above-fold images)
  - fallback (optional): Boolean - Use placeholder if image missing. Default: true
  
  GENERATED OUTPUT:
  - Responsive <img> tag with optimized srcset for 400w, 800w, 1200w versions
  - Mobile-first sizes attribute based on purpose and viewport
  - Proper loading and decoding attributes for performance
  - Accessibility-compliant alt text
  - Optional placeholder fallback for missing images
  
  USAGE:
  {% include components/images/collection-image.html 
     collection="brands" slug="ru-teatime" purpose="hero" 
     alt="TeaTime storefront in Moscow" %}
  
  {% include components/images/collection-image.html 
     collection="founders" slug="ru-alexei-sokolov" purpose="portrait" 
     alt="Alexei Sokolov, founder of TeaTime" loading="eager" %}
  
  EXAMPLES FROM BRANDMINE:
  1. Brand hero image (_includes/pages/brand/hero.html):
     {% include components/images/collection-image.html
        collection="brands" slug=brand.ref purpose="hero" name="storefront"
        alt=brand.title loading="eager" %}
  
  2. Founder portrait (_includes/components/cards/founder-card.html):
     {% include components/images/collection-image.html
        collection="founders" slug=founder.ref purpose="portrait"
        alt=founder.name aspect="portrait" %}
  
  3. Insight feature image (_includes/pages/insight/hero.html):
     {% include components/images/collection-image.html
        collection="insights" slug=page.slug purpose="feature"
        alt=page.title ratio="16:9" %}
  
  IMAGE REQUIREMENTS:
  - Original images: /assets/images/[collection]/[slug]/originals/[purpose]-[name].[ext]
  - Processed versions: Generated by _scripts/core/process_images.sh
  - Required sizes: 400w, 800w, 1200w for each image
  - Naming convention: [purpose]-[name]-[width]w.[ext]
  
  RESPONSIVE BEHAVIOR:
  - Hero images: 100vw on mobile, 80vw on tablet, 1200px max on desktop
  - Gallery images: 100vw on mobile, 50vw on tablet, 33vw on desktop
  - Thumbnails: Fixed 200px on all devices
  - Portraits: 100vw mobile, 300px tablet+
  
  ACCESSIBILITY:
  - Required alt text parameter ensures all images have descriptions
  - Decorative images can use alt="" but must be explicitly set
  - Images lazy load with proper sizing to prevent layout shift
  
  PERFORMANCE NOTES:
  - Mobile-first sizes attribute minimizes bandwidth usage
  - Lazy loading by default reduces initial page load
  - WebP format supported with fallback to JPEG
  - Placeholder prevents broken image layouts
  
  ERROR HANDLING:
  - Missing images fall back to collection-specific placeholders
  - Invalid parameters use sensible defaults
  - Console warnings in development for missing required parameters
  
  LAST UPDATED: 2025-01-12 by Claude
  VERSION: 3.0 (Complete mobile-first responsive implementation)
{% endcomment %}


{% comment %} Build the image path {% endcomment %}
{% assign path = '/assets/images/' | append: include.collection | append: '/' %}
{% if include.category %}
  {% assign path = path | append: include.category | append: '/' %}
{% endif %}
{% assign path = path | append: include.slug | append: '/' %}

{% comment %} Build the filename {% endcomment %}
{% assign filename = include.purpose %}
{% if include.name %}
  {% assign filename = filename | append: "-" | append: include.name %}
{% endif %}

{% comment %} Mobile-first sizes optimized for available srcset widths (400w, 800w, 1200w) {% endcomment %}
{% case include.aspect | default: 'landscape' %}
  {% when 'portrait' %}
    {% if include.purpose == 'headshot' or include.purpose == 'testimonial' %}
      {% comment %} Small fixed-size images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 120px, (max-width: 768px) 160px, (max-width: 1200px) 200px, 250px" %}
    {% elsif include.purpose == 'founder' or include.purpose == 'profile' %}
      {% comment %} Medium-sized profile images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 70vw, (max-width: 768px) 50vw, (max-width: 1200px) 40vw, 500px" %}
    {% else %}
      {% comment %} Default portrait sizes {% endcomment %}
      {% assign sizes = "(max-width: 480px) 50vw, (max-width: 768px) 40vw, (max-width: 1200px) 33vw, 400px" %}
    {% endif %}

  {% when 'square' %}
    {% if include.purpose == 'logo' %}
      {% comment %} Small logo sizes {% endcomment %}
      {% assign sizes = "(max-width: 480px) 100px, (max-width: 768px) 120px, (max-width: 1200px) 150px, 200px" %}
    {% elsif include.purpose == 'avatar' or include.purpose == 'icon' %}
      {% comment %} Very small square images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 60px, (max-width: 768px) 80px, (max-width: 1200px) 100px, 120px" %}
    {% else %}
      {% comment %} Default square sizes {% endcomment %}
      {% assign sizes = "(max-width: 480px) 40vw, (max-width: 768px) 30vw, (max-width: 1200px) 25vw, 300px" %}
    {% endif %}

  {% else %}
    {% comment %} Landscape or unspecified aspect ratio {% endcomment %}
    {% if include.purpose == 'hero' %}
      {% comment %} Full-width hero images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 100vw, (max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px" %}
    {% elsif include.purpose == 'thumbnail' %}
      {% comment %} Small preview images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 45vw, (max-width: 768px) 30vw, (max-width: 1200px) 200px, 250px" %}
    {% elsif include.purpose == 'gallery' %}
      {% comment %} Grid gallery images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 45vw, (max-width: 768px) 30vw, (max-width: 1200px) 25vw, 300px" %}
    {% elsif include.purpose == 'product' %}
      {% comment %} Product showcase images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 100vw, (max-width: 768px) 50vw, (max-width: 1200px) 33vw, 400px" %}
    {% elsif include.purpose == 'feature' %}
      {% comment %} Featured content images {% endcomment %}
      {% assign sizes = "(max-width: 480px) 100vw, (max-width: 768px) 70vw, (max-width: 1200px) 50vw, 600px" %}
    {% else %}
      {% comment %} Default landscape sizes {% endcomment %}
      {% assign sizes = "(max-width: 480px) 100vw, (max-width: 768px) 85vw, (max-width: 1200px) 50vw, 600px" %}
    {% endif %}
{% endcase %}

{% comment %} Set loading priority {% endcomment %}
{% if include.loading %}
  {% assign loading_attr = include.loading %}
{% else %}
  {% assign loading_attr = "lazy" %}
{% endif %}

{% comment %} Set file extension {% endcomment %}
{% if include.ext %}
  {% assign file_ext = include.ext %}
{% else %}
  {% assign file_ext = "jpg" %}
{% endif %}

{% comment %} Build fallback path if needed {% endcomment %}
{% unless include.fallback == false %}
  {% assign fallback_filename = include.collection | append: "-" | append: include.purpose %}
  {% assign fallback_path = "/assets/images/placeholders/" | append: fallback_filename | append: "-400w." | append: file_ext %}
{% endunless %}

{% comment %} Output the responsive image with fallback support {% endcomment %}
<img src="{{ path | append: filename | append: '-400w.' | append: file_ext | relative_url }}"
     srcset="{{ path | append: filename | append: '-400w.' | append: file_ext | relative_url }} 400w,
             {{ path | append: filename | append: '-800w.' | append: file_ext | relative_url }} 800w,
             {{ path | append: filename | append: '-1200w.' | append: file_ext | relative_url }} 1200w"
     sizes="{{ sizes }}"
     alt="{{ include.alt }}"
     {% if include.class %}class="{{ include.class }}"{% endif %}
     {% if include.ratio %}data-ratio="{{ include.ratio }}"{% endif %}
     {% if include.purpose %}data-purpose="{{ include.purpose }}"{% endif %}
     {% if fallback_path %}onerror="this.src='{{ fallback_path | relative_url }}'; this.onerror=null;"{% endif %}
     loading="{{ loading_attr }}">
