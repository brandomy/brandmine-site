<!-- _includes/pages/brand/connections.html -->
{% assign t = site.data.translations[page.lang].brand %}
{% assign tags_t = site.data.translations[page.lang].tags %}

<section class="brand-section brand-section--connections" id="connections">
  <div class="brand-section__container">
    <h2 class="brand-section__title">{{ tags_t.related_brands }}</h2>

    <div class="brand-connections">
      <!-- Related Brands (Auto-generated) -->
      <div class="brand-connections__related">
        {% assign related_brands = site.brands | where: "lang", page.lang | where_exp: "brand", "brand.ref != page.ref" %}

        <!-- Filter for related brands based on sector -->
        {% assign sector_related = related_brands | where_exp: "brand", "brand.sectors and page.sectors and brand.sectors[0] == page.sectors[0]" | limit: 3 %}

        <!-- If not enough sector-related, add market-related -->
        {% assign sector_count = sector_related | size %}
        {% if sector_count < 3 %}
          {% assign market_related = related_brands | where_exp: "brand", "brand.markets and page.markets and brand.markets[0] == page.markets[0]" | where_exp: "brand", "brand.sectors[0] != page.sectors[0]" | limit: 3 | offset: sector_count %}
          {% assign related_brands_all = sector_related | concat: market_related | limit: 3 %}
        {% else %}
          {% assign related_brands_all = sector_related %}
        {% endif %}

        <!-- Display Related Brands -->
        <div class="related-brands-grid">
          {% for brand in related_brands_all %}
            {% include components/cards/related-brand-card.html
              brand=brand
              lang=page.lang %}
          {% endfor %}
        </div>

        <!-- View All Brands Button -->
        <div class="brand-connections__all">
          <a href="{{ site.baseurl }}/{{ page.lang }}/brands/" class="btn btn-outline-primary">
            {{ tags_t.view_all_brands }}
          </a>
        </div>
      </div>

      <!-- Further Discovery Links -->
      <div class="brand-connections__discovery">
        <h3>{{ site.data.translations[page.lang].discover.explore }}</h3>

        <div class="discovery-links">
          <!-- Sector Discovery -->
          {% if page.sectors and page.sectors.size > 0 %}
            <div class="discovery-link">
              <a href="{{ site.baseurl }}/{{ page.lang }}/discover/sectors/{{ page.sectors[0] }}/" class="discovery-card discovery-card--sector">
                {% include components/icons/dimension-icon.html type="sector" name=page.sectors[0] %}
                <div class="discovery-card__content">
                  <h4 class="discovery-card__title">{{ tags_t.sectors }}</h4>
                  <p class="discovery-card__text">{{ site.data.translations[page.lang].discover.explore_sector }}</p>
                </div>
              </a>
            </div>
          {% endif %}

          <!-- Market Discovery -->
          {% if page.markets and page.markets.size > 0 %}
            <div class="discovery-link">
              <a href="{{ site.baseurl }}/{{ page.lang }}/discover/markets/{{ page.markets[0] }}/" class="discovery-card discovery-card--market">
                {% include components/icons/dimension-icon.html type="market" name=page.markets[0] %}
                <div class="discovery-card__content">
                  <h4 class="discovery-card__title">{{ tags_t.markets }}</h4>
                  <p class="discovery-card__text">{{ site.data.translations[page.lang].discover.explore_market }}</p>
                </div>
              </a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Related Insights -->
      {% include components/brand/related-insights.html
        brand_slug=page.ref
        lang=page.lang
        limit=2 %}
    </div>
  </div>
</section>
