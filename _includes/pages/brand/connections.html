{% comment %}
  Connections Section
  Displays: Related brands, relevant insights, contact information
  Supports: Both YAML and JSON data sources
{% endcomment %}

{% assign brand = include.brand %}
{% assign data_source = include.data_source | default: "curated" %}
{% assign t = site.data.translations[brand.lang].brand %}

<div class="panel panel--light">
  <div class="panel__content">
    <h2 id="heading-connections" class="panel__heading-secondary">
      {{ site.data.translations[brand.lang].discover.connections | default: "Connections & Discovery" }}
    </h2>
    
    <div class="connections">
      {% comment %} Related Brands {% endcomment %}
      {% if brand.sectors or brand.markets or brand.attributes %}
      <div class="connections__section">
        <h3 class="connections__title">
          {{ t.related_brands | default: "Related Brands" }}
        </h3>
        
        {% comment %} Find brands with overlapping taxonomy {% endcomment %}
        {% assign related_brands = site.data.brands.brands | where_exp: "b", "b.ref != include.brand_ref" %}
        {% assign matching_brands = "" | split: "" %}
        
        {% for related_brand in related_brands limit: 6 %}
          {% assign has_match = false %}
          
          {% comment %} Check for sector overlap {% endcomment %}
          {% if brand.sectors %}
            {% for sector in brand.sectors %}
              {% if related_brand.sectors contains sector %}
                {% assign has_match = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% comment %} Check for market overlap {% endcomment %}
          {% unless has_match %}
            {% if brand.markets %}
              {% for market in brand.markets %}
                {% if related_brand.markets contains market %}
                  {% assign has_match = true %}
                  {% break %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endunless %}
          
          {% if has_match %}
            {% assign matching_brands = matching_brands | push: related_brand %}
          {% endif %}
        {% endfor %}
        
        {% if matching_brands.size > 0 %}
        <div class="related-brands">
          {% for related_brand in matching_brands limit: 3 %}
            <div class="brand-card brand-card--compact">
              <h4 class="brand-card__name">
                <a href="{{ site.baseurl }}/{{ brand.lang }}/brands/{{ related_brand.ref }}/">
                  {{ related_brand.name }}
                </a>
              </h4>
              {% if related_brand.description %}
                <p class="brand-card__description">{{ related_brand.description | truncate: 100 }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      {% comment %} Contact Information {% endcomment %}
      <div class="connections__section">
        <h3 class="connections__title">
          {{ t.contact | default: "Contact Information" }}
        </h3>
        
        <div class="contact-info">
          {% if brand.website %}
          <div class="contact-item">
            <span class="contact-label">{{ t.website | default: "Website" }}:</span>
            <a href="{{ brand.website }}" target="_blank" class="contact-link">{{ brand.website }}</a>
          </div>
          {% endif %}
          
          {% if brand.social_media %}
            {% for social_item in brand.social_media %}
              {% if social_item[1] and social_item[1] != "" %}
              <div class="contact-item">
                <span class="contact-label">{{ site.data.translations[brand.lang].social[social_item[0]] | default: social_item[0] | capitalize }}:</span>
                <a href="{{ social_item[1] }}" target="_blank" class="contact-link social-link social-link--{{ social_item[0] }}">
                  {{ social_item[1] | remove: 'https://' | remove: 'http://' }}
                </a>
              </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>